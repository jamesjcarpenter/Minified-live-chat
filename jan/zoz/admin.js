var server=null;server="http:"===window.location.protocol?"http://"+window.location.hostname+":7088/admin":"https://"+window.location.hostname+":7889/admin";var secret="",session=null,handle=null,plugins=[],pluginsIndex=[],settings={},currentHandle=null,localSdp=null,remoteSdp=null;$(document).ready(function(){"undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),$("#admintabs a").click(function(e){e.preventDefault(),$(this).tab("show")}),server||(server=""),secret||(secret=""),""!==server&&""!==secret?updateServerInfo():promptAccessDetails()});var prompting=!1,alerted=!1;function promptAccessDetails(){if(!prompting){prompting=!0;bootbox.alert({message:"<div class='input-group margin-bottom-sm'>\t<span class='input-group-addon'><i class='fa fa-cloud-upload fa-fw'></i></span>\t<input class='form-control' type='text' value='"+server+"' placeholder='Insert the address of the Admin API backend' autocomplete='off' id='server'></input></div><div class='input-group margin-bottom-sm'>\t<span class='input-group-addon'><i class='fa fa-key fa-fw'></i></span>\t<input class='form-control' type='password'  value='"+secret+"'placeholder='Insert the Admin API secret' autocomplete='off' id='secret'></input></div>",closeButton:!1,callback:function(){prompting=!1,server=$("#server").val(),secret=$("#secret").val(),updateServerInfo()}})}}function randomString(e){charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var t="",n=0;n<e;n++){var o=Math.floor(Math.random()*charSet.length);t+=charSet.substring(o,o+1)}return t}function updateServerInfo(){plugins=[],pluginsIndex=[],$.ajax({type:"GET",url:server+"/info",cache:!1,contentType:"application/json",success:function(e){if("server_info"!==e.janus)return console.log("Ooops: "+e.error.code+" "+e.error.reason),void(prompting||alerted||(alerted=!0,bootbox.alert(e.error.reason,function(){promptAccessDetails(),alerted=!1})));console.log("Got server info:"),console.log(e);var t=e.plugins,n=e.transports,o=e.events;for(var s in delete e.janus,delete e.transaction,delete e.plugins,delete e.transports,delete e.events,$("#server-details").empty(),e)if("dependencies"!==s){var a=e[s];$("#server-details").append("<tr>\t<td><b>"+s+":</b></td>\t<td>"+a+"</td></tr>")}else for(var r in $("#server-deps").html("<tr>\t<th>Library</th>\t<th>Version</th></tr>"),e[s])$("#server-deps").append("<tr>\t<td>"+r+"</td>\t<td>"+e[s][r]+"</td></tr>");for(var i in $("#server-plugins").html("<tr>\t<th>Name</th>\t<th>Author</th>\t<th>Description</th>\t<th>Version</th></tr>"),$("#plugins-list").empty(),t){plugins.push(i);a=t[i];$("#server-plugins").append("<tr>\t<td>"+a.name+"</td>\t<td>"+a.author+"</td>\t<td>"+a.description+"</td>\t<td>"+a.version_string+"</td></tr>"),pluginsIndex.push(i),$("#plugins-list").append('<a id="plugin-'+(pluginsIndex.length-1)+'" href="#" class="list-group-item">'+i+"</a>"),$("#plugin-"+(pluginsIndex.length-1)).click(function(e){e.preventDefault();var t=parseInt($(this).attr("id").split("plugin-")[1]),n=pluginsIndex[t];console.log("Selected plugin:",n),$("#plugins-list a").removeClass("active"),$("#plugin-"+t).addClass("active"),resetPluginRequest()})}for(var l in $("#server-transports").html("<tr>\t<th>Name</th>\t<th>Author</th>\t<th>Description</th>\t<th>Version</th></tr>"),n){a=n[l];$("#server-transports").append("<tr>\t<td>"+a.name+"</td>\t<td>"+a.author+"</td>\t<td>"+a.description+"</td>\t<td>"+a.version_string+"</td></tr>")}for(var d in $("#server-handlers").html("<tr>\t<th>Name</th>\t<th>Author</th>\t<th>Description</th>\t<th>Version</th></tr>"),o){a=o[d];$("#server-handlers").append("<tr>\t<td>"+a.name+"</td>\t<td>"+a.author+"</td>\t<td>"+a.description+"</td>\t<td>"+a.version_string+"</td></tr>")}$("#admintabs li").removeClass("disabled"),updateSettings(),$("#handles").hide(),$("#info").hide(),$("#update-sessions").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").click(updateHandleInfo),updateSessions(),$("#autorefresh").change(function(){this.checked&&updateHandleInfo(!0)}),$("#prettify").change(function(){this.checked?prettyHandleInfo():rawHandleInfo()}),$("#capture").change(function(){this.checked?($("#capturetext").html("Stop capture"),captureTrafficPrompt()):($("#capturetext").html("Start capture"),captureTrafficRequest(!1,!0===handleInfo["dump-to-text2pcap"]))}),e.auth_token?updateTokens():($("a[href=#tokens]").parent().addClass("disabled"),$("a[href=#tokens]").attr("href","#").unbind("click").click(function(e){return e.preventDefault(),!1}))},error:function(e,t,n){console.log(t+": "+n),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function updateSettings(){$("#update-settings").unbind("click").addClass("fa-spin");var e={janus:"get_status",transaction:randomString(12),admin_secret:secret};$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"!==e.janus){console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;return t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)})),void setTimeout(function(){$("#update-settings").removeClass("fa-spin").click(updateSettings)},1e3)}for(var n in console.log("Got status:"),console.log(e),setTimeout(function(){$("#update-settings").removeClass("fa-spin").click(updateSettings)},1e3),$("#server-settings").empty(),e.status)settings[n]=e.status[n],$("#server-settings").append("<tr>\t<td><b>"+n+":</b></td>\t<td>"+settings[n]+'</td>\t<td id="'+n+'"></td></tr>'),"session_timeout"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs btn-primary">Edit session timeout value</button>'),$("#"+n+"_button").click(function(){bootbox.prompt("Set the new session timeout value (in seconds, currently "+settings.session_timeout+")",function(e){if(isNaN(e))bootbox.alert("Invalid session timeout value");else{if((e=parseInt(e))<0)return console.log(isNaN(e)),console.log(e<0),void bootbox.alert("Invalid session timeout value");setSessionTimeoutValue(e)}})})):"log_level"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs btn-primary">Edit log level</button>'),$("#"+n+"_button").click(function(){bootbox.prompt("Set the new desired log level (0-7, currently "+settings.log_level+")",function(e){if(isNaN(e))bootbox.alert("Invalid log level (should be [0,7])");else{if((e=parseInt(e))<0||e>7)return console.log(isNaN(e)),console.log(e<0),console.log(e>7),void bootbox.alert("Invalid log level (should be [0,7])");setLogLevel(e)}})})):"max_nack_queue"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs btn-primary">Edit max NACK queue</button>'),$("#"+n+"_button").click(function(){bootbox.prompt("Set the new desired max NACK queue (a positive integer, currently "+settings.max_nack_queue+")",function(e){isNaN(e)?bootbox.alert("Invalid max NACK queue (should be a positive integer)"):(e=parseInt(e))<0?bootbox.alert("Invalid max NACK queue (should be a positive integer)"):setMaxNackQueue(e)})})):"no_media_timer"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs btn-primary">Edit no-media timer value</button>'),$("#"+n+"_button").click(function(){bootbox.prompt("Set the new desired no-media timer value (in seconds, currently "+settings.no_media_timer+")",function(e){isNaN(e)?bootbox.alert("Invalid no-media timer (should be a positive integer)"):(e=parseInt(e))<0?bootbox.alert("Invalid no-media timer (should be a positive integer)"):setNoMediaTimer(e)})})):"slowlink_threshold"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs btn-primary">Edit slowlink-threshold value</button>'),$("#"+n+"_button").click(function(){bootbox.prompt("Set the new desired slowlink-threshold value (in lost packets per seconds, currently "+settings.slowlink_threshold+")",function(e){isNaN(e)?bootbox.alert("Invalid slowlink-threshold timer (should be a positive integer)"):(e=parseInt(e))<0?bootbox.alert("Invalid slowlink-threshold timer (should be a positive integer)"):setSlowlinkThreshold(e)})})):"locking_debug"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs"></button>'),$("#"+n+"_button").addClass(settings[n]?"btn-danger":"btn-success").html(settings[n]?"Disable locking debug":"Enable locking debug"),$("#"+n+"_button").click(function(){var e=settings.locking_debug?"Are you sure you want to disable the locking debug?":"Are you sure you want to enable the locking debug?<br/>This will print a line on the console any time a mutex is locked/unlocked";bootbox.confirm(e,function(e){e&&setLockingDebug(!settings.locking_debug)})})):"refcount_debug"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs"></button>'),$("#"+n+"_button").addClass(settings[n]?"btn-danger":"btn-success").html(settings[n]?"Disable reference counters debug":"Enable reference counters debug"),$("#"+n+"_button").click(function(){var e=settings.refcount_debug?"Are you sure you want to disable the reference counters debug?":"Are you sure you want to enable the reference counters debug?<br/>This will print a line on the console any time a reference counter is increased/decreased";bootbox.confirm(e,function(e){e&&setRefcountDebug(!settings.refcount_debug)})})):"log_timestamps"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs"></button>'),$("#"+n+"_button").addClass(settings[n]?"btn-danger":"btn-success").html(settings[n]?"Disable log timestamps":"Enable log timestamps"),$("#"+n+"_button").click(function(){var e=settings.log_timestamps?"Are you sure you want to disable the log timestamps?":"Are you sure you want to enable the log timestamps?<br/>This will print the current date/time for each new line on the console";bootbox.confirm(e,function(e){e&&setLogTimestamps(!settings.log_timestamps)})})):"log_colors"===n?($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs"></button>'),$("#"+n+"_button").addClass(settings[n]?"btn-danger":"btn-success").html(settings[n]?"Disable log colors":"Enable log colors"),$("#"+n+"_button").click(function(){var e=settings.log_colors?"Are you sure you want to disable the log colors?":"Are you sure you want to enable the log colors?<br/>This will strip the colors from events like warnings, errors, etc. on the console";bootbox.confirm(e,function(e){e&&setLogColors(!settings.log_colors)})})):"libnice_debug"===n&&($("#"+n).append('<button id="'+n+'_button" type="button" class="btn btn-xs"></button>'),$("#"+n+"_button").addClass(settings[n]?"btn-danger":"btn-success").html(settings[n]?"Disable libnice debug":"Enable libnice debug"),$("#"+n+"_button").click(function(){var e=settings.libnice_debug?"Are you sure you want to disable the libnice debug?":"Are you sure you want to enable the libnice debug?<br/>This will print the a very verbose debug of every libnice-related operation on the console";bootbox.confirm(e,function(e){e&&setLibniceDebug(!settings.libnice_debug)})}))},error:function(e,t,n){console.log(t+": "+n),$("#update-settings").removeClass("fa-spin").click(updateSettings),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function setSessionTimeoutValue(e){sendSettingsRequest({janus:"set_session_timeout",timeout:e,transaction:randomString(12),admin_secret:secret})}function setLogLevel(e){sendSettingsRequest({janus:"set_log_level",level:e,transaction:randomString(12),admin_secret:secret})}function setLockingDebug(e){sendSettingsRequest({janus:"set_locking_debug",debug:e,transaction:randomString(12),admin_secret:secret})}function setRefcountDebug(e){sendSettingsRequest({janus:"set_refcount_debug",debug:e,transaction:randomString(12),admin_secret:secret})}function setLogTimestamps(e){sendSettingsRequest({janus:"set_log_timestamps",timestamps:e,transaction:randomString(12),admin_secret:secret})}function setLogColors(e){sendSettingsRequest({janus:"set_log_colors",colors:e,transaction:randomString(12),admin_secret:secret})}function setLibniceDebug(e){sendSettingsRequest({janus:"set_libnice_debug",debug:e,transaction:randomString(12),admin_secret:secret})}function setMaxNackQueue(e){sendSettingsRequest({janus:"set_max_nack_queue",max_nack_queue:e,transaction:randomString(12),admin_secret:secret})}function setNoMediaTimer(e){sendSettingsRequest({janus:"set_no_media_timer",no_media_timer:e,transaction:randomString(12),admin_secret:secret})}function setSlowlinkThreshold(e){sendSettingsRequest({janus:"set_slowlink_threshold",slowlink_threshold:e,transaction:randomString(12),admin_secret:secret})}function sendSettingsRequest(e){console.log(e),$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"===e.janus)updateSettings();else{console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)}))}},error:function(e,t,n){console.log(t+": "+n),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function resetPluginRequest(){$("#plugin-request").empty().append('<tr style="background: #f9f9f9;">\t<th width="25%">Name</th>\t<th width="25%">Value</th>\t<th width="25%">Type</th>\t<th></th></tr><tr>\t<td><i id="addattr" class="fa fa-plus-circle" style="cursor: pointer;"></i></td>\t<td></td>\t<td></td>\t<td><button id="sendmsg" type="button" class="btn btn-xs btn-success pull-right">Send message</button></td></tr>'),$("#addattr").click(addPluginMessageAttribute).click(),$("#sendmsg").click(function(){for(var e={},t=$(".pm-property").length,n=0;n<t;n++){var o=$("#attrname"+n).val();if(""===o)return void bootbox.alert("Missing name in attribute #"+(n+1));if(null!==e[o]&&void 0!==e[o])return void bootbox.alert("Duplicate attribute '"+o+"'");var s=$("#attrvalue"+n).val();if(""===s)return void bootbox.alert("Missing value in attribute #"+(n+1));var a=$("#attrtype"+n).val();if("number"===a){if(s=parseInt(s),isNaN(s))return void bootbox.alert("Invalid value in attribute #"+(n+1)+" (expecting a number)")}else if("boolean"===a)if("true"===s.toLowerCase())s=!0;else{if("false"!==s.toLowerCase())return void bootbox.alert("Invalid value in attribute #"+(n+1)+" (expecting a boolean)");s=!1}console.log("Type:",a),e[o]=s}sendPluginMessage($("#plugins-list .active").text(),e)}),$("#plugin-message").removeClass("hide")}function addPluginMessageAttribute(){var e=$(".pm-property").length;$("#addattr").parent().parent().before('<tr>\t<td><input type="text" id="attrname'+e+'" placeholder="Attribute name" onkeypress="return checkEnter(this, event);" style="width: 100%;" class="pm-property form-control input-sm"></td>\t<td><input type="text" id="attrvalue'+e+'" placeholder="Attribute value" onkeypress="return checkEnter(this, event);" style="width: 100%;" class="form-control input-sm"></td>\t<td>\t\t<select id="attrtype'+e+'" class="form-control input-sm">\t\t\t<option>string</option>\t\t\t<option>number</option>\t\t\t<option>boolean</option>\t\t</select>\t</td>\t<td></td></tr>')}function sendPluginMessage(e,t){console.log("Sending message to "+e+":",t);var n={janus:"message_plugin",transaction:randomString(12),admin_secret:secret,plugin:e,request:t};$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(n),success:function(e){if("success"!==e.janus){console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)}))}$("#plugin-response").text(JSON.stringify(e,null,4))},error:function(e,t,n){console.log(t+": "+n),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function updateSessions(){$("#update-sessions").unbind("click").addClass("fa-spin"),$("#update-handles").unbind("click"),$("#update-handle").unbind("click");var e={janus:"list_sessions",transaction:randomString(12),admin_secret:secret};$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"!==e.janus){console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;return t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)})),setTimeout(function(){$("#update-sessions").removeClass("fa-spin").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").click(updateHandleInfo)},1e3),session=null,handle=null,currentHandle=null,$("#handles-list").empty(),$("#handles").hide(),$("#handle-info").empty(),$("#options").hide(),void $("#info").hide()}console.log("Got sessions:"),console.log(e),$("#sessions-list").empty();var n=e.sessions;$("#sessions-num").text(n.length);for(var o=0;o<n.length;o++){var s=n[o];$("#sessions-list").append('<a id="session-'+s+'" href="#" class="list-group-item">'+s+"</a>"),$("#session-"+s).click(function(){var e=$(this).text();console.log("Getting session "+e+" handles"),session=e,$("#sessions-list a").removeClass("active"),$("#session-"+e).addClass("active"),handle=null,currentHandle=null,$("#handles-list").empty(),$("#handles").show(),$("#handle-info").empty(),$("#options").hide(),$("#info").hide(),updateHandles()})}null!=session&&($("#session-"+session).length?$("#session-"+session).addClass("active"):(session=null,handle=null,currentHandle=null,$("#handles-list").empty(),$("#handles").hide(),$("#handle-info").empty(),$("#options").hide(),$("#info").hide())),setTimeout(function(){$("#update-sessions").removeClass("fa-spin").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").click(updateHandleInfo)},1e3)},error:function(e,t,n){console.log(t+": "+n),setTimeout(function(){$("#update-sessions").removeClass("fa-spin").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").click(updateHandleInfo)},1e3),session=null,handle=null,currentHandle=null,$("#handles-list").empty(),$("#handles").hide(),$("#handle-info").empty(),$("#options").hide(),$("#info").hide(),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function updateHandles(){if(null!=session){$("#update-sessions").unbind("click"),$("#update-handles").unbind("click").addClass("fa-spin"),$("#update-handle").unbind("click");var e={janus:"list_handles",transaction:randomString(12),admin_secret:secret};$.ajax({type:"POST",url:server+"/"+session,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"!==e.janus){console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;return t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)})),void setTimeout(function(){$("#update-handles").removeClass("fa-spin").click(updateHandles),$("#update-sessions").click(updateSessions),$("#update-handle").click(updateHandleInfo)},1e3)}console.log("Got handles:"),console.log(e),$("#handles-list").empty();var n=e.handles;$("#handles-num").text(n.length);for(var o=0;o<n.length;o++){var s=n[o];$("#handles-list").append('<a id="handle-'+s+'" href="#" class="list-group-item">'+s+"</a>"),$("#handle-"+s).click(function(){var e=$(this).text();console.log("Getting handle "+e+" info"),(handle=e)!==currentHandle&&($("#handles-list a").removeClass("active"),$("#handle-"+e).addClass("active"),$("#handle-info").empty(),$("#options").hide(),$("#info").show(),updateHandleInfo())})}null!=handle&&($("#handle-"+handle).length?$("#handle-"+handle).addClass("active"):(handle=null,currentHandle=null,$("#handle-info").empty(),$("#options").hide(),$("#info").hide())),setTimeout(function(){$("#update-handles").removeClass("fa-spin").click(updateHandles),$("#update-sessions").click(updateSessions),$("#update-handle").click(updateHandleInfo)},1e3)},error:function(e,t,n){console.log(t+": "+n),$("#update-handles").removeClass("fa-spin").click(updateHandles),$("#update-sessions").click(updateSessions),$("#update-handle").click(updateHandleInfo),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}}function updateHandleInfo(e){if(null!=handle){if(!0!==e){if(handle===currentHandle&&$("#autorefresh")[0].checked)return;currentHandle=handle}var t=currentHandle;$("#update-sessions").unbind("click"),$("#update-handles").unbind("click"),$("#update-handle").unbind("click").addClass("fa-spin"),$("#capture").removeAttr("checked"),$("#capturetext").html("Start capture");var n={janus:"handle_info",transaction:randomString(12),admin_secret:secret};$.ajax({type:"POST",url:server+"/"+session+"/"+handle,cache:!1,contentType:"application/json",data:JSON.stringify(n),success:function(n){if("success"===n.janus)console.log("Got info:"),console.log(n),handleInfo=n.info,$("#prettify")[0].checked?prettyHandleInfo():rawHandleInfo(),(handleInfo["dump-to-pcap"]||handleInfo["dump-to-text2pcap"])&&($("#capture").attr("checked",!0),$("#capturetext").html("Stop capture")),setTimeout(function(){$("#update-sessions").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").removeClass("fa-spin").click(updateHandleInfo)},1e3),$("#options").removeClass("hide").show(),$("#autorefresh")[0].checked&&setTimeout(function(){t===currentHandle&&$("#autorefresh")[0].checked&&updateHandleInfo(!0)},5e3);else{if(console.log("Ooops: "+n.error.code+" "+n.error.reason),!0!==e){var o=403===n.error.code;o&&(!o||prompting||alerted)||(o&&(alerted=!0),bootbox.alert(n.error.reason,function(){o&&(promptAccessDetails(),alerted=!1)}))}setTimeout(function(){$("#update-sessions").click(updateSessions),$("#update-handles").click(updateHandles),$("#update-handle").removeClass("fa-spin").click(updateHandleInfo)},1e3)}},error:function(e,t,n){console.log(t+": "+n),$("#update-handles").removeClass("fa-spin").click(updateHandles),$("#update-sessions").click(updateSessions),$("#update-handle").click(updateHandleInfo),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}}function rawHandleInfo(){$("#handle-info").html("<pre>"+JSON.stringify(handleInfo,null,4)+"</pre>")}function prettyHandleInfo(){for(var e in $("#handle-info").html('<table class="table table-striped" id="handle-info-table"></table>'),$("#options").hide(),handleInfo){var t=handleInfo[e];if("plugin_specific"===e)for(var n in $("#handle-info").append('<h4>Plugin specific details</h4><table class="table table-striped" id="plugin-specific"></table>'),t){var o=t[n];$("#plugin-specific").append("<tr>\t<td><b>"+n+":</b></td>\t<td>"+o+"</td></tr>")}else if("flags"===e)for(var n in $("#handle-info").append('<h4>Flags</h4><table class="table table-striped" id="flags"></table>'),t){o=t[n];$("#flags").append("<tr>\t<td><b>"+n+":</b></td>\t<td>"+o+"</td></tr>")}else if("sdps"===e)for(var n in localSdp=null,remoteSdp=null,$("#handle-info").append('<h4>Session descriptions (SDP)</h4><table class="table table-striped" id="sdps"></table>'),t){o=t[n];if("local"===n)localSdp=o;else{if("remote"!==n)continue;remoteSdp=o}$("#sdps").append("<tr>\t<td><b>"+n+':</b></td>\t<td><a id="'+n+'" href="#">'+o.substring(0,40)+"...</a></td></tr>"),$("#"+n).click(function(e){e.preventDefault();var t="local"===$(this).attr("id")?localSdp:remoteSdp;bootbox.dialog({title:"SDP ("+$(this).attr("id")+")",message:'<div style="max-height: '+2*$(window).height()/3+'px; overflow-y: auto;">'+t.split("\r\n").join("<br/>")+"</div>"})})}else if("streams"===e)for(var n in $("#handle-info").append('<h4>ICE streams</h4><div id="streams"></table>'),t){$("#streams").append("<h5>Stream #"+(parseInt(n)+1)+'</h5><table class="table table-striped" id="stream'+n+'"></table>');o=t[n];for(var s in console.log(o),o){var a=o[s];if("ssrc"===s)for(var r in $("#stream"+n).append('<tr><td colspan="2"><h6>SSRC</h6><table class="table" id="ssrc'+n+'"></table></td></tr>'),a){var i=a[r];$("#ssrc"+n).append("<tr>\t<td><b>"+r+":</b></td>\t<td>"+i+"</td></tr>")}else if("components"===s)for(var r in $("#stream"+n).append('<tr><td colspan="2"><h6>Components of Stream #'+(parseInt(n)+1)+'</h6><table class="table" id="components'+n+'"></table></td></tr>'),a){i=a[r];for(var l in $("#components"+n).append('<tr><td colspan="2"><h6>Component #'+(parseInt(r)+1)+'</h6><table class="table" id="stream'+n+"component"+r+'"></table></td></tr>'),i){var d=i[l];if("local-candidates"===l||"remote-candidates"===l){var c="<ul>";for(var u in d)c+="<li>"+d[u]+"</li>";c+="</ul>",$("#stream"+n+"component"+r).append("<tr>\t<td><b>"+l+":</b></td>\t<td>"+c+"</td></tr>")}else if("dtls"===l||"in_stats"===l||"out_stats"===l){var p='<table class="table">';for(var b in d)p+='<tr><td style="width:150px;"><b>'+b+"</b></td><td>"+d[b]+"</td></tr>";p+="</table>",$("#stream"+n+"component"+r).append('<tr>\t<td style="width:150px;"><b>'+l+":</b></td>\t<td>"+p+"</td></tr>")}else $("#stream"+n+"component"+r).append("<tr>\t<td><b>"+l+":</b></td>\t<td>"+d+"</td></tr>")}}else $("#stream"+n).append("<tr>\t<td><b>"+s+":</b></td>\t<td>"+a+"</td></tr>")}}else $("#handle-info-table").append("<tr>\t<td><b>"+e+":</b></td>\t<td>"+t+"</td></tr>")}$("#options").show()}function updateTokens(){$("#update-tokens").unbind("click").addClass("fa-spin");var e={janus:"list_tokens",transaction:randomString(12),admin_secret:secret};$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"!==e.janus){console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;return t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)})),void setTimeout(function(){$("#update-tokens").removeClass("fa-spin").click(updateTokens)},1e3)}for(var n in console.log("Got tokens:"),console.log(e.data.tokens),setTimeout(function(){$("#update-tokens").removeClass("fa-spin").click(updateTokens)},1e3),$("#auth-tokens").html("<tr>\t<th>Token</th>\t<th>Permissions</th>\t<th></th></tr>"),e.data.tokens){var o=e.data.tokens[n],s=o.allowed_plugins.toString().replace(/,/g,"<br/>");$("#auth-tokens").append("<tr>\t<td>"+o.token+"</td>\t<td>"+s+'</td>\t<td><button  id="'+o.token+'" type="button" class="btn btn-xs btn-danger">Remove token</button></td></tr>'),$("#"+o.token).click(function(){var e=$(this).attr("id");bootbox.confirm("Are you sure you want to remove token "+e+"?",function(t){t&&removeToken(e)})})}$("#auth-tokens").append('<tr>\t<td><input type="text" id="token" placeholder="Token to add" onkeypress="return checkEnter(this, event);" style="width: 100%;"></td>\t<td><div id="permissions"></div></td>\t<td><button id="addtoken" type="button" class="btn btn-xs btn-success">Add token</button></td></tr>');var a="";for(var r in plugins){var i=plugins[r];a+='<div class="checkbox">\t<label>\t\t<input checked type="checkbox" value="'+i+'">'+i+"</input></div>"}$("#permissions").html(a),$("#addtoken").click(function(){var e=$("#token").val().replace(/ /g,"");if(""!==e){var t=$(":checked");if(0!==t.length){for(var n=[],o=0;o<t.length;o++)n.push(t[o].value);var s="Are you sure you want to add the new token "+e+" with access to the following plugins?<br/><ul>";for(var o in n)s+="<li>"+n[o]+"</li>";s+="</ul>",bootbox.confirm(s,function(t){t&&addToken(e,n)})}else bootbox.alert("Please allow the token access to at least a plugin")}else bootbox.alert("Please insert a valid token string")})},error:function(e,t,n){console.log(t+": "+n),$("#update-settings").removeClass("fa-spin").click(updateSettings),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function addToken(e,t){sendTokenRequest({janus:"add_token",token:e,plugins:t,transaction:randomString(12),admin_secret:secret})}function removeToken(e){sendTokenRequest({janus:"remove_token",token:e,transaction:randomString(12),admin_secret:secret})}function sendTokenRequest(e){console.log(e),$.ajax({type:"POST",url:server,cache:!1,contentType:"application/json",data:JSON.stringify(e),success:function(e){if("success"===e.janus)updateTokens();else{console.log("Ooops: "+e.error.code+" "+e.error.reason);var t=403===e.error.code;t&&(!t||prompting||alerted)||(t&&(alerted=!0),bootbox.alert(e.error.reason,function(){t&&(promptAccessDetails(),alerted=!1)}))}},error:function(e,t,n){console.log(t+": "+n),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function captureTrafficPrompt(){bootbox.dialog({title:"Start capturing traffic",message:'<div class="form-content">\t<form class="form" role="form">\t\t<div class="form-group">\t\t\t<label for="type">Capture Type</label>\t\t\t<select class="form-control" id="type" name="type" value="pcal">\t\t\t\t<option value="pcap">pcap</option>\t\t\t\t<option value="text2pcap">text2pcap</option>\t\t\t</select>\t\t</div>\t\t<div class="form-group">\t\t\t<label for="extra">Folder to save in</label>\t\t\t<input type="text" class="form-control" id="folder" name="folder" placeholder="Insert a path to the target folder" value=""></input>\t\t</div>\t\t<div class="form-group">\t\t\t<label for="extra">Filename</label>\t\t\t<input type="text" class="form-control" id="filename" name="filename" placeholder="Insert the target filename" value=""></input>\t\t</div>\t\t<div class="form-group">\t\t\t<label for="extra">Truncate</label>\t\t\t<input type="text" class="form-control" id="truncate" name="truncate" placeholder="Bytes to truncate at (0 or omit to save the whole packet)" value=""></input>\t\t</div>\t</form></div>',buttons:[{label:"Start",className:"btn btn-primary pull-left",callback:function(){var e="text2pcap"===$("#type").val(),t=""!==$("#folder").val()?$("#folder").val():void 0,n=""!==$("#filename").val()?$("#filename").val():void 0,o=parseInt($("#truncate").val());o&&!isNaN(o)||(o=0),captureTrafficRequest(!0,e,t,n,o)}},{label:"Close",className:"btn btn-default pull-left",callback:function(){$("#capture").removeAttr("checked"),$("#capturetext").html("Start capture")}}]})}function captureTrafficRequest(e,t,n,o,s){var a={janus:e?t?"start_text2pcap":"start_pcap":t?"stop_text2pcap":"stop_pcap",transaction:randomString(12),admin_secret:secret};e&&(a.folder=n,a.filename=o,a.truncate=s),$.ajax({type:"POST",url:server+"/"+session+"/"+handle,cache:!1,contentType:"application/json",data:JSON.stringify(a),success:function(t){if("success"!==t.janus)return console.log("Ooops: "+t.error.code+" "+t.error.reason),bootbox.alert(t.error.reason),void(e&&-1===t.error.reason.indexOf("already")&&($("#capture").removeAttr("checked"),$("#capturetext").html("Start capture")))},error:function(e,t,n){console.log(t+": "+n),prompting||alerted||(alerted=!0,bootbox.alert("Couldn't contact the backend: is Janus down, or is the Admin/Monitor interface disabled?",function(){promptAccessDetails(),alerted=!1}))},dataType:"json"})}function checkEnter(e,t){return 13!=(t.keyCode?t.keyCode:t.which?t.which:t.charCode)||("token"==e.id?$("#addtoken").click():-1!==e.id.indexOf("attr")&&$("#sendmsg").click(),!1)}