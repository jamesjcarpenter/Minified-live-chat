var server=null;server="http:"===window.location.protocol?"http://"+window.location.hostname+":8088/janus":"https://"+window.location.hostname+":8089/janus";var janus=null,sfutest=null,opaqueId="videoroomtest-"+Janus.randomString(12),url=window.location.href;function getImageDirectoryByFullURL(e){return e.substr(e.lastIndexOf("=")+1)}console.log(url),console.log(url.substr(url.lastIndexOf("=")+1));var namePos=Math.abs(url.substr(url.lastIndexOf("=")+1)),myroom=null;window.location.protocol,myroom=namePos;var myusername=null,myid=null,mystream=null,mypvtid=null,feeds=[],bitrateTimer=[],doSimulcast="yes"===getQueryStringValue("simulcast")||"true"===getQueryStringValue("simulcast"),doSimulcast2="yes"===getQueryStringValue("simulcast2")||"true"===getQueryStringValue("simulcast2");function checkEnter(e,t){return 13!=(t.keyCode?t.keyCode:t.which?t.which:t.charCode)||(registerUsername(),!1)}function registerUsername(){if(0===$("#username").length)$("#register").click(registerUsername),$("#username").focus();else{$("#username").attr("disabled",!0),$("#register").attr("disabled",!0).unbind("click");var e=$("#username").val();if(""===e)return $("#you").removeClass().addClass("label label-warning").html("Insert your display name (e.g., pippo)"),$("#username").removeAttr("disabled"),void $("#register").removeAttr("disabled").click(registerUsername);if(/[^a-zA-Z0-9]/.test(e))return $("#you").removeClass().addClass("label label-warning").html("Input is not alphanumeric"),$("#username").removeAttr("disabled").val(""),void $("#register").removeAttr("disabled").click(registerUsername);var t={request:"join",room:myroom,ptype:"publisher",display:e};myusername=e,sfutest.send({message:t})}}function publishOwnFeed(e){$("#publish").attr("disabled",!1).unbind("click"),$("#unpublish").attr("disabled",!1).unbind("click"),$("#unpublish").click(unpublishOwnFeed),$("#videolocal").parent().parent().unblock(),$("#videolocal").show(),sfutest.createOffer({media:{audioRecv:!1,videoRecv:!1,audioSend:e,videoSend:!0},simulcast:doSimulcast,simulcast2:doSimulcast2,success:function(t){Janus.debug("Got publisher SDP!"),Janus.debug(t);var s={request:"configure",audio:e,video:!0};sfutest.send({message:s,jsep:t})},error:function(t){Janus.error("WebRTC error:",t),e?publishOwnFeed(!1):(bootbox.alert("WebRTC error... "+JSON.stringify(t)),$("#publish").removeAttr("disabled").click(function(){publishOwnFeed(!0)}))}})}function toggleMute(){var e=sfutest.isAudioMuted();Janus.log((e?"Unmuting":"Muting")+" local stream..."),e?sfutest.unmuteAudio():sfutest.muteAudio(),e=sfutest.isAudioMuted(),$("#mute").html(e?"<i class='volume mute icon'>":"<i class='volume up icon'>")}function unpublishOwnFeed(){$("#unpublish").attr("disabled",!0).unbind("click");sfutest.send({message:{request:"unpublish"}}),$("#videolocal").parent().parent().block(),$("#videolocal").hide()}function newRemoteFeed(e,t,s,a){var i=null;janus.attach({plugin:"janus.plugin.videoroom",opaqueId:opaqueId,success:function(t){(i=t).simulcastStarted=!1,Janus.log("Plugin attached! ("+i.getPlugin()+", id="+i.getId()+")"),Janus.log("  -- This is a subscriber");var s={request:"join",room:myroom,ptype:"subscriber",feed:e,private_id:mypvtid};"safari"!==Janus.webRTCAdapter.browserDetails.browser||"vp9"!==a&&("vp8"!==a||Janus.safariVp8)||(a&&(a=a.toUpperCase()),toastr.warning("Publisher is using "+a+", but Safari doesn't support it: disabling video"),s.offer_video=!1),i.videoCodec=a,i.send({message:s})},error:function(e){Janus.error("  -- Error attaching plugin...",e),bootbox.alert("Error attaching plugin... "+e)},onmessage:function(e,t){Janus.debug(" ::: Got a message (subscriber) :::"),Janus.debug(e);var s=e.videoroom;if(Janus.debug("Event: "+s),void 0!==e.error&&null!==e.error)bootbox.alert(e.error);else if(null!=s&&null!=s)if("attached"===s){for(var a=1;a<6;a++)if(void 0===feeds[a]||null===feeds[a]){feeds[a]=i,i.rfindex=a;break}i.rfid=e.id,i.rfdisplay=e.display,Janus.log("Successfully attached to feed "+i.rfid+" ("+i.rfdisplay+") in room "+e.room),$("#remote"+i.rfindex).removeClass("hide").html(i.rfdisplay).show()}else if("event"===s){var n=e.substream,r=e.temporal;null==n&&null==r||(i.simulcastStarted||(i.simulcastStarted=!0,addSimulcastButtons(i.rfindex,"vp8"===i.videoCodec||"h264"===i.videoCodec)),updateSimulcastButtons(i.rfindex,n,r))}null!=t&&(Janus.debug("Handling SDP as well..."),Janus.debug(t),i.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1},success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);var t={request:"start",room:myroom};i.send({message:t,jsep:e})},error:function(e){Janus.error("WebRTC error:",e),bootbox.alert("WebRTC error... "+JSON.stringify(e))}}))},webrtcState:function(e){Janus.log("Janus says this WebRTC PeerConnection (feed #"+i.rfindex+") is "+(e?"up":"down")+" now")},onlocalstream:function(e){},onremotestream:function(e){Janus.debug("Remote feed #"+i.rfindex);var t=!1;0===$("#remotevideo"+i.rfindex).length&&(t=!0,$("#videoremote"+i.rfindex).append('<video class="rounded centered" id="waitingvideo'+i.rfindex+'" width=320 height=240 />'),$("#videoremote"+i.rfindex).append('<video class="rounded centered relative hide" id="remotevideo'+i.rfindex+'" width="100%" height="100%" autoplay playsinline/>'),$("#remotevideo"+i.rfindex).bind("playing",function(){$("#waitingvideo"+i.rfindex).remove(),this.videoWidth&&$("#remotevideo"+i.rfindex).removeClass("hide").show();this.videoWidth,this.videoHeight;"firefox"===Janus.webRTCAdapter.browserDetails.browser&&setTimeout(function(){$("#remotevideo"+i.rfindex).get(0).videoWidth,$("#remotevideo"+i.rfindex).get(0).videoHeight},2e3)})),Janus.attachMediaStream($("#remotevideo"+i.rfindex).get(0),e);var s=e.getVideoTracks();null==s||0===s.length?($("#remotevideo"+i.rfindex).hide(),0===$("#videoremote"+i.rfindex+" .no-video-container").length&&$("#videoremote"+i.rfindex).append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text"></span></div>')):($("#videoremote"+i.rfindex+" .no-video-container").remove(),$("#remotevideo"+i.rfindex).removeClass("hide").show()),t&&("chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser||(bitrateTimer[i.rfindex]=setInterval(function(){i.getBitrate();var e=$("#remotevideo"+i.rfindex).get(0).videoWidth,t=$("#remotevideo"+i.rfindex).get(0).videoHeight;e>0&&t>0&&$("#curres"+i.rfindex).removeClass("hide").text(e+"x"+t).hide()},1e3)))},oncleanup:function(){Janus.log(" ::: Got a cleanup notification (remote feed "+e+") :::"),$("#remotevideo"+i.rfindex).remove(),$("#waitingvideo"+i.rfindex).remove(),$("#novideo"+i.rfindex).remove(),null!==bitrateTimer[i.rfindex]&&null!==bitrateTimer[i.rfindex]&&clearInterval(bitrateTimer[i.rfindex]),bitrateTimer[i.rfindex]=null,i.simulcastStarted=!1,$("#simulcast"+i.rfindex).remove()}})}function getQueryStringValue(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function addSimulcastButtons(e,t){var s=e;$("#remote"+s).parent().append('<div id="simulcast'+s+'" class="btn-group-vertical btn-group-vertical-xs pull-right">\t<div class"row">\t\t<div class="btn-group btn-group-xs" style="width: 100%">\t\t\t<button id="sl'+s+'-2" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to higher quality" style="width: 33%">SL 2</button>\t\t\t<button id="sl'+s+'-1" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to normal quality" style="width: 33%">SL 1</button>\t\t\t<button id="sl'+s+'-0" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to lower quality" style="width: 34%">SL 0</button>\t\t</div>\t</div>\t<div class"row">\t\t<div class="btn-group btn-group-xs hide" style="width: 100%">\t\t\t<button id="tl'+s+'-2" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 2" style="width: 34%">TL 2</button>\t\t\t<button id="tl'+s+'-1" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 1" style="width: 33%">TL 1</button>\t\t\t<button id="tl'+s+'-0" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 0" style="width: 33%">TL 0</button>\t\t</div>\t</div></div>'),$("#sl"+s+"-0").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (lower quality)",null,{timeOut:2e3}),$("#sl"+s+"-2").hasClass("btn-success")||$("#sl"+s+"-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl"+s+"-1").hasClass("btn-success")||$("#sl"+s+"-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl"+s+"-0").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),feeds[s].send({message:{request:"configure",substream:0}})}),$("#sl"+s+"-1").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (normal quality)",null,{timeOut:2e3}),$("#sl"+s+"-2").hasClass("btn-success")||$("#sl"+s+"-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl"+s+"-1").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#sl"+s+"-0").hasClass("btn-success")||$("#sl"+s+"-0").removeClass("btn-primary btn-info").addClass("btn-primary"),feeds[s].send({message:{request:"configure",substream:1}})}),$("#sl"+s+"-2").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (higher quality)",null,{timeOut:2e3}),$("#sl"+s+"-2").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#sl"+s+"-1").hasClass("btn-success")||$("#sl"+s+"-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl"+s+"-0").hasClass("btn-success")||$("#sl"+s+"-0").removeClass("btn-primary btn-info").addClass("btn-primary"),feeds[s].send({message:{request:"configure",substream:2}})}),t&&($("#tl"+s+"-0").parent().removeClass("hide"),$("#tl"+s+"-0").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (lowest FPS)",null,{timeOut:2e3}),$("#tl"+s+"-2").hasClass("btn-success")||$("#tl"+s+"-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl"+s+"-1").hasClass("btn-success")||$("#tl"+s+"-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl"+s+"-0").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),feeds[s].send({message:{request:"configure",temporal:0}})}),$("#tl"+s+"-1").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (medium FPS)",null,{timeOut:2e3}),$("#tl"+s+"-2").hasClass("btn-success")||$("#tl"+s+"-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl"+s+"-1").removeClass("btn-primary btn-info").addClass("btn-info"),$("#tl"+s+"-0").hasClass("btn-success")||$("#tl"+s+"-0").removeClass("btn-primary btn-info").addClass("btn-primary"),feeds[s].send({message:{request:"configure",temporal:1}})}),$("#tl"+s+"-2").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (highest FPS)",null,{timeOut:2e3}),$("#tl"+s+"-2").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#tl"+s+"-1").hasClass("btn-success")||$("#tl"+s+"-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl"+s+"-0").hasClass("btn-success")||$("#tl"+s+"-0").removeClass("btn-primary btn-info").addClass("btn-primary"),feeds[s].send({message:{request:"configure",temporal:2}})}))}function updateSimulcastButtons(e,t,s){var a=e;0===t?(toastr.success("Switched simulcast substream! (lower quality)",null,{timeOut:2e3}),$("#sl"+a+"-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl"+a+"-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl"+a+"-0").removeClass("btn-primary btn-info btn-success").addClass("btn-success")):1===t?(toastr.success("Switched simulcast substream! (normal quality)",null,{timeOut:2e3}),$("#sl"+a+"-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl"+a+"-1").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#sl"+a+"-0").removeClass("btn-primary btn-success").addClass("btn-primary")):2===t&&(toastr.success("Switched simulcast substream! (higher quality)",null,{timeOut:2e3}),$("#sl"+a+"-2").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#sl"+a+"-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl"+a+"-0").removeClass("btn-primary btn-success").addClass("btn-primary")),0===s?(toastr.success("Capped simulcast temporal layer! (lowest FPS)",null,{timeOut:2e3}),$("#tl"+a+"-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl"+a+"-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl"+a+"-0").removeClass("btn-primary btn-info btn-success").addClass("btn-success")):1===s?(toastr.success("Capped simulcast temporal layer! (medium FPS)",null,{timeOut:2e3}),$("#tl"+a+"-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl"+a+"-1").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#tl"+a+"-0").removeClass("btn-primary btn-success").addClass("btn-primary")):2===s&&(toastr.success("Capped simulcast temporal layer! (highest FPS)",null,{timeOut:2e3}),$("#tl"+a+"-2").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#tl"+a+"-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl"+a+"-0").removeClass("btn-primary btn-success").addClass("btn-primary"))}$(document).ready(function(){Janus.init({debug:"all",callback:function(){$("#start").one("click",function(){$(this).attr("disabled",!0).unbind("click"),Janus.isWebrtcSupported()?janus=new Janus({server:server,success:function(){janus.attach({plugin:"janus.plugin.videoroom",opaqueId:opaqueId,success:function(e){$("#details").remove(),sfutest=e,Janus.log("Plugin attached! ("+sfutest.getPlugin()+", id="+sfutest.getId()+")"),Janus.log("  -- This is a publisher/manager");var t={request:"join",room:myroom,ptype:"publisher",display:socket.username};sfutest.send({message:t}),$("#start").removeAttr("disabled").html("Stop").click(function(){$(this).attr("disabled",!0),janus.destroy()})},error:function(e){Janus.error("  -- Error attaching plugin...",e),bootbox.alert("Error attaching plugin... "+e)},consentDialog:function(e){Janus.debug("Consent dialog should be "+(e?"on":"off")+" now"),e?$.blockUI({message:'<div><img src="images/up_arrow.png"/></div>',css:{border:"none",padding:"15px",backgroundColor:"transparent",color:"#aaa",top:"10px",left:navigator.mozGetUserMedia?"-100px":"300px"}}):$.unblockUI()},mediaState:function(e,t){Janus.log("Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){Janus.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),$("#videolocal").parent().parent().unblock(),e&&($("#bitrate").parent().parent().removeClass("hide").show(),$("#bitrate a").click(function(){var e=$(this).attr("id"),t=1e3*parseInt(e);return 0===t?Janus.log("Not limiting bandwidth via REMB"):Janus.log("Capping bandwidth to "+t+" via REMB"),$("#bitrateset").html($(this).html()+'<span class="caret"></span>').parent().removeClass("open"),sfutest.send({message:{request:"configure",bitrate:t}}),!1}))},onmessage:function(e,t){Janus.debug(" ::: Got a message (publisher) :::"),Janus.debug(e);var s=e.videoroom;if(Janus.debug("Event: "+s),null!=s&&null!=s)if("joined"===s){if(myid=e.id,mypvtid=e.private_id,Janus.log("Successfully joined room "+e.room+" with ID "+myid),mystream=null,$("#publish").click(function(){publishOwnFeed(!0)}),$("#videolocal").parent().parent().unblock(),$("#bitrate").parent().parent().addClass("hide"),$("#bitrate a").unbind("click"),void 0!==e.publishers&&null!==e.publishers){var a=e.publishers;for(var i in Janus.debug("Got a list of available publishers/feeds:"),Janus.debug(a),a){var n=a[i].id,r=a[i].display,o=a[i].audio_codec,l=a[i].video_codec;Janus.debug("  >> ["+n+"] "+r+" (audio: "+o+", video: "+l+")"),newRemoteFeed(n,r,o,l)}}}else if("destroyed"===s)Janus.warn("The room has been destroyed!"),bootbox.alert("The room has been destroyed",function(){window.location.reload()});else if("event"===s)if(void 0!==e.publishers&&null!==e.publishers){a=e.publishers;for(var i in Janus.debug("Got a list of available publishers/feeds:"),Janus.debug(a),a){n=a[i].id,r=a[i].display,o=a[i].audio_codec,l=a[i].video_codec;Janus.debug("  >> ["+n+"] "+r+" (audio: "+o+", video: "+l+")"),newRemoteFeed(n,r,o,l)}}else if(void 0!==e.leaving&&null!==e.leaving){var d=e.leaving;Janus.log("Publisher left: "+d);for(var u=null,c=1;c<6;c++)if(null!=feeds[c]&&null!=feeds[c]&&feeds[c].rfid==d){u=feeds[c];break}null!=u&&(Janus.debug("Feed "+u.rfid+" ("+u.rfdisplay+") has left the room, detaching"),$("#remote"+u.rfindex).empty().hide(),$("#videoremote"+u.rfindex).empty(),feeds[u.rfindex]=null,u.detach())}else if(void 0!==e.unpublished&&null!==e.unpublished){var m=e.unpublished;if(Janus.log("Publisher left: "+m),"ok"===m)return void sfutest.hangup();for(u=null,c=1;c<6;c++)if(null!=feeds[c]&&null!=feeds[c]&&feeds[c].rfid==m){u=feeds[c];break}null!=u&&(Janus.debug("Feed "+u.rfid+" ("+u.rfdisplay+") has left the room, detaching"),$("#remote"+u.rfindex).empty().hide(),$("#videoremote"+u.rfindex).empty(),feeds[u.rfindex]=null,u.detach())}else void 0!==e.error&&null!==e.error&&(426===e.error_code?bootbox.alert("<p>Apparently room <code>"+myroom+"</code> (the one this demo uses as a test room) does not exist...</p><p>Do you have an updated <code>janus.plugin.videoroom.cfg</code> configuration file? If not, make sure you copy the details of room <code>"+myroom+"</code> from that sample in your current configuration file, then restart Janus and try again."):bootbox.alert(e.error));if(null!=t){Janus.debug("Handling SDP as well..."),Janus.debug(t),sfutest.handleRemoteJsep({jsep:t});o=e.audio_codec;mystream&&mystream.getAudioTracks()&&mystream.getAudioTracks().length>0&&!o&&toastr.warning("Our audio stream has been rejected, viewers won't hear us");l=e.video_codec;mystream&&mystream.getVideoTracks()&&mystream.getVideoTracks().length>0&&!l&&(toastr.warning("Our video stream has been rejected, viewers won't see us"),$("#myvideo").hide(),$("#videolocal").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon" style="height: 100%;"></i><span class="no-video-text" style="font-size: 16px;">Video rejected, no webcam</span></div>'))}},onlocalstream:function(e){Janus.debug(" ::: Got a local stream :::"),mystream=e,Janus.debug(e),$("#videojoin").hide(),$("#videos").removeClass("hide").show(),0===$("#myvideo").length&&($("#videolocal").append('<video class="rounded centered" id="myvideo" width="100%" height="100%" autoplay playsinline muted="muted"/>'),$("#videolocal").append('<button class="ui mini compact icon button" id="mute" style="position: absolute; bottom: -40px; left: 118px; margin: 15px;"><i class="volume up icon"></i></button>'),$("#mute").click(toggleMute),$("#videolocal").append('<button class="ui mini compact icon button" id="unpublish" style="position: absolute; bottom: -40px; right: 118px; margin: 15px;"><i class="times circle icon"></button>'),$("#unpublish").click(unpublishOwnFeed)),$("#publisher").removeClass("hide").html(myusername).show(),Janus.attachMediaStream($("#myvideo").get(0),e),$("#myvideo").get(0).muted="muted","completed"!==sfutest.webrtcStuff.pc.iceConnectionState&&"connected"!==sfutest.webrtcStuff.pc.iceConnectionState&&$("#videolocal").parent().parent().block({message:"<b>CAMMING UP...</b>",css:{border:"none",backgroundColor:"transparent",color:"white"}});var t=e.getVideoTracks();null==t||0===t.length?($("#myvideo").hide(),0===$("#videolocal .no-video-container").length&&$("#videolocal").append('<div class="no-video-container"><i class="camera icon"></i><span class="no-video-text">No webcam available</span></div>')):($("#videolocal .no-video-container").remove(),$("#myvideo").removeClass("hide").show())},onremotestream:function(e){},oncleanup:function(){Janus.log(" ::: Got a cleanup notification: we are unpublished now :::"),mystream=null,$("#publish").click(function(){publishOwnFeed(!0)}),$("#videolocal").parent().parent().unblock(),$("#videolocal").hide(),$("#bitrate").parent().parent().addClass("hide"),$("#bitrate a").unbind("click")}})},error:function(e){Janus.error(e),bootbox.alert(e,function(){window.location.reload()})},destroyed:function(){window.location.reload()}}):bootbox.alert("No WebRTC support... ")})}})});