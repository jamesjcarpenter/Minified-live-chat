function checkEnter(e,a){return 13!=(a.keyCode?a.keyCode:a.which?a.which:a.charCode)||("username"==e.id?registerUsername():"peer"==e.id?doCall():"datasend"==e.id&&sendData(),!1)}function doCall(){$("#peer").attr("disabled",!0),$("#call").attr("disabled",!0).unbind("click");var e=$("#peer").val();if(""===e)return bootbox.alert("Insert a username to call (e.g., pluto)"),$("#peer").removeAttr("disabled"),void $("#call").removeAttr("disabled").click(doCall);/[^a-zA-Z0-9]/.test(e)&&(bootbox.alert("Input is not alphanumeric"),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").click(doCall),videocall.createOffer({media:{data:!0},simulcast:doSimulcast,success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);var a={request:"call",username:$("#peer").val()};videocall.send({message:a,jsep:e})},error:function(e){Janus.error("WebRTC error...",e),bootbox.alert("WebRTC error... "+e)}}))}function doHangup(){$("#call").attr("disabled",!0).unbind("click");videocall.send({message:{request:"hangup"}}),videocall.hangup(),yourusername=null}function sendData(){var e=$("#datasend").val();""!==e?videocall.data({text:e,error:function(e){bootbox.alert(e)},success:function(){$("#datasend").val("")}}):bootbox.alert("Insert a message to send on the DataChannel to your peer")}function getQueryStringValue(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))}window.addEventListener("DOMContentLoaded",e=>{var a=null;a="http:"===window.location.protocol?"http://"+window.location.hostname+":8088/janus":"https://"+window.location.hostname+":8089/janus";var t,o=null,n=null,s="videocalltest-"+Janus.randomString(12),i=null,l=null;null==t&&(t=[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:165.22.137.67:80",username:"apostles00@yahoo.com",credential:"Zero!"}]);var r=!1,d=!1,u=null,c=null,v="yes"===getQueryStringValue("simulcast")||"true"===getQueryStringValue("simulcast"),b=("yes"===getQueryStringValue("simulcast2")||getQueryStringValue("simulcast2"),!1);Janus.init({debug:!0,callback:function(){$("#start").one("click",function(){$(this).attr("disabled",!0).unbind("click"),Janus.isWebrtcSupported()?o=new Janus({server:a,success:function(){o.attach({plugin:"janus.plugin.videocall",opaqueId:s,success:function(e){$("#details").remove(),n=e,Janus.log("Plugin attached! ("+n.getPlugin()+", id="+n.getId()+")"),setTimeout(function(){var e={request:"register",username:u=Math.random().toString(36).substring(7)};n.send({message:e})},5500),$("#videocall").removeClass("hide").show(),$("#start").removeAttr("disabled").html("Stop").click(function(){$(this).attr("disabled",!0)})},error:function(e){Janus.error("  -- Error attaching plugin...",e),bootbox.alert("  -- Error attaching plugin... "+e)},consentDialog:function(e){Janus.debug("Consent dialog should be "+(e?"on":"off")+" now"),e?$.blockUI({message:'<div><img src="up_arrow.png"/></div>',css:{border:"none",padding:"15px",backgroundColor:"transparent",color:"#aaa",top:"10px",left:navigator.mozGetUserMedia?"-100px":"300px"}}):$.unblockUI()},mediaState:function(e,a){Janus.log("Janus "+(a?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){Janus.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),$("#videoleft").parent().unblock()},onmessage:function(e,a){Janus.debug(" ::: Got a message :::"),Janus.debug(e);var t=e.result;if(null!=t){if(void 0!==t.list&&null!==t.list){var o=t.list;for(var s in Janus.debug("Got a list of registered peers:"),Janus.debug(o),o)Janus.debug("  >> ["+o[s]+"]")}else if(void 0!==t.event&&null!==t.event){var r=t.event;if("registered"===r)u=t.username,Janus.log("Successfully registered as "+u+"!"),$("#youok").removeClass("hide").show().html("Registered as '"+u+"'"),n.send({message:{request:"list"}}),$("#phone").removeClass("hide").show(),$("#call").unbind("click").click(doCall),$("#peer").focus();else if("calling"===r)Janus.log("Waiting for the peer to answer..."),bootbox.alert("Waiting for the peer to answer...");else if("incomingcall"===r)Janus.log("Incoming call from "+t.username+"!"),c=t.username,bootbox.hideAll(),incoming=bootbox.dialog({message:"Incoming call from "+c+"!",title:"Incoming call",closeButton:!1,buttons:{success:{label:"Answer",className:"btn-success",callback:function(){incoming=null,$("#peer").val(t.username).attr("disabled",!0),n.createAnswer({jsep:a,media:{data:!0},simulcast:v,success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);n.send({message:{request:"accept"},jsep:e}),$("#peer").attr("disabled",!0),$("#call").removeAttr("disabled").html("Hangup").removeClass("btn-success").addClass("btn-danger").unbind("click").click(doHangup)},error:function(e){Janus.error("WebRTC error:",e),bootbox.alert("WebRTC error... "+JSON.stringify(e))}})}},danger:{label:"Decline",className:"btn-danger",callback:function(){doHangup()}}}});else if("accepted"===r){bootbox.hideAll();var d=t.username;null==d?Janus.log("Call started!"):(Janus.log(d+" accepted the call!"),c=d),a&&n.handleRemoteJsep({jsep:a}),$("#call").removeAttr("disabled").html("Hangup").removeClass("btn-success").addClass("btn-danger").unbind("click").click(doHangup)}else if("update"===r)a&&("answer"===a.type?n.handleRemoteJsep({jsep:a}):n.createAnswer({jsep:a,media:{data:!0},success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);n.send({message:{request:"set"},jsep:e})},error:function(e){Janus.error("WebRTC error:",e),bootbox.alert("WebRTC error... "+JSON.stringify(e))}}));else if("hangup"===r)Janus.log("Call hung up by "+t.username+" ("+t.reason+")!"),bootbox.hideAll(),n.hangup(),null!=l&&l.stop(),$("#waitingvideo").remove(),$("#videos").hide(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide();else if("simulcast"===r){var g=t.substream,m=t.temporal;null==g&&null==m||(b||(b=!0,addSimulcastButtons("vp8"===t.videocodec||"h264"===t.videocodec)),updateSimulcastButtons(g,m))}}}else{var h=e.error;bootbox.alert(h),h.indexOf("already taken")>0&&($("#usernameinput").removeAttr("disabled").val(""),$("#register").removeAttr("disabled").unbind("click").click(registerUsername)),n.hangup(),null!=l&&l.stop(),$("#waitingvideo").remove(),$("#videos").hide(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide(),null!==i&&null!==i&&clearInterval(i),i=null}},onlocalstream:function(e){if(Janus.debug(" ::: Got a local stream :::"),Janus.debug(e),$("#videos").removeClass("hide").show(),0===$("#myvideo").length&&$("#videoleft").append('<video class="rounded centered" id="myvideo" width=320 height=240 autoplay playsinline muted="muted"/>'),Janus.attachMediaStream($("#myvideo").get(0),e),$("#myvideo").get(0).muted="muted","completed"!==n.webrtcStuff.pc.iceConnectionState&&"connected"!==n.webrtcStuff.pc.iceConnectionState)if($("#videoleft").parent().block({message:"<b>Publishing...</b>",css:{border:"none",backgroundColor:"transparent",color:"white"}}),$("#videoright").append('<video class="rounded centered" id="waitingvideo" width=320 height=240 />'),null==l){var a=document.getElementById("videoright");l=new Spinner({top:100}).spin(a)}else l.spin();var t=e.getVideoTracks();null==t||0===t.length?($("#myvideo").hide(),0===$("#videoleft .no-video-container").length&&$("#videoleft").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No webcam available</span></div>')):($("#videoleft .no-video-container").remove(),$("#myvideo").removeClass("hide").show())},onremotestream:function(e){Janus.debug(" ::: Got a remote stream :::"),Janus.debug(e);var a=!1;0===$("#remotevideo").length&&(a=!0,$("#videoright").append('<video class="rounded centered hide" id="remotevideo" width=320 height=240 autoplay playsinline/>'),$("#remotevideo").bind("playing",function(){$("#waitingvideo").remove(),this.videoWidth&&$("#remotevideo").removeClass("hide").show(),null!=l&&l.stop(),l=null;var e=this.videoWidth,a=this.videoHeight;$("#curres").removeClass("hide").text(e+"x"+a).show()}),$("#callee").removeClass("hide").html(c).show()),Janus.attachMediaStream($("#remotevideo").get(0),e);var t=e.getVideoTracks();null==t||0===t.length?($("#remotevideo").hide(),0===$("#videoright .no-video-container").length&&$("#videoright").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No remote video available</span></div>')):($("#videoright .no-video-container").remove(),$("#remotevideo").removeClass("hide").show()),a&&(r=!0,d=!0,$("#toggleaudio").html("Disable audio").removeClass("btn-success").addClass("btn-danger").unbind("click").removeAttr("disabled").click(function(){(r=!r)?$("#toggleaudio").html("Disable audio").removeClass("btn-success").addClass("btn-danger"):$("#toggleaudio").html("Enable audio").removeClass("btn-danger").addClass("btn-success"),n.send({message:{request:"set",audio:r}})}),$("#togglevideo").html("Disable video").removeClass("btn-success").addClass("btn-danger").unbind("click").removeAttr("disabled").click(function(){(d=!d)?$("#togglevideo").html("Disable video").removeClass("btn-success").addClass("btn-danger"):$("#togglevideo").html("Enable video").removeClass("btn-danger").addClass("btn-success"),n.send({message:{request:"set",video:d}})}),$("#toggleaudio").parent().removeClass("hide").show(),$("#bitrateset").html("Bandwidth"),$("#bitrate a").unbind("click").removeAttr("disabled").click(function(){var e=$(this).attr("id"),a=1e3*parseInt(e);return 0===a?Janus.log("Not limiting bandwidth via REMB"):Janus.log("Capping bandwidth to "+a+" via REMB"),$("#bitrateset").html($(this).html()).parent().removeClass("open"),n.send({message:{request:"set",bitrate:a}}),!1}),"chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser||($("#curbitrate").removeClass("hide").show(),i=setInterval(function(){var e=n.getBitrate();$("#curbitrate").text(e);var a=$("#remotevideo").get(0).videoWidth,t=$("#remotevideo").get(0).videoHeight;a>0&&t>0&&$("#curres").removeClass("hide").text(a+"x"+t).show()},1e3)))},ondataopen:function(e){Janus.log("The DataChannel is available!"),$("#videos").removeClass("hide").show(),$("#datasend").removeAttr("disabled")},ondata:function(e){Janus.debug("We got data from the DataChannel! "+e),$("#datarecv").val(e)},oncleanup:function(){Janus.log(" ::: Got a cleanup notification :::"),$("#myvideo").remove(),$("#remotevideo").remove(),$("#videoleft").parent().unblock(),$(".no-video-container").remove(),$("#callee").empty().hide(),c=null,$("#curbitrate").hide(),$("#curres").hide(),$("#videos").hide(),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide(),null!==i&&null!==i&&clearInterval(i),i=null,$("#waitingvideo").remove(),$("#videos").hide(),b=!1,$("#simulcast").remove(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall)}})},error:function(e){Janus.error(e),bootbox.alert(e,function(){window.location.reload()})},destroyed:function(){window.location.reload()}}):bootbox.alert("No WebRTC support... ")})}})});