var server=null;server="http:"===window.location.protocol?"http://"+window.location.hostname+":8088/janus":"https://"+window.location.hostname+":8089/janus";var janus=null,videocall=null,opaqueId="videocalltest-"+Janus.randomString(12),bitrateTimer=null,spinner=null,audioenabled=!1,videoenabled=!1,myusername=null,yourusername=null,doSimulcast="yes"===getQueryStringValue("simulcast")||"true"===getQueryStringValue("simulcast"),doSimulcast2="yes"===getQueryStringValue("simulcast2")||"true"===getQueryStringValue("simulcast2"),simulcastStarted=!1;function checkEnter(e,t){return 13!=(t.keyCode?t.keyCode:t.which?t.which:t.charCode)||("username"==e.id?registerUsername():"peer"==e.id?doCall():"datasend"==e.id&&sendData(),!1)}function registerUsername(){$("#username").attr("disabled",!0),$("#register").attr("disabled",!0).unbind("click");var e=$("#username").val();if(""===e)return bootbox.alert("Insert a username to register (e.g., pippo)"),$("#username").removeAttr("disabled"),void $("#register").removeAttr("disabled").click(registerUsername);if(/[^a-zA-Z0-9]/.test(e))return bootbox.alert("Input is not alphanumeric"),$("#username").removeAttr("disabled").val(""),void $("#register").removeAttr("disabled").click(registerUsername);var t={request:"register",username:e};videocall.send({message:t})}function doCall(){$("#peer").attr("disabled",!0),$("#call").attr("disabled",!0).unbind("click");var e=$("#peer").val();return""===e?(bootbox.alert("Insert a username to call (e.g., pluto)"),$("#peer").removeAttr("disabled"),void $("#call").removeAttr("disabled").click(doCall)):/[^a-zA-Z0-9]/.test(e)?(bootbox.alert("Input is not alphanumeric"),$("#peer").removeAttr("disabled").val(""),void $("#call").removeAttr("disabled").click(doCall)):void videocall.createOffer({media:{data:!0},simulcast:doSimulcast,success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);var t={request:"call",username:$("#peer").val()};videocall.send({message:t,jsep:e})},error:function(e){Janus.error("WebRTC error...",e),bootbox.alert("WebRTC error... "+e)}})}function doHangup(){$("#call").attr("disabled",!0).unbind("click");videocall.send({message:{request:"hangup"}}),videocall.hangup(),yourusername=null}function sendData(){var e=$("#datasend").val();""!==e?videocall.data({text:e,error:function(e){bootbox.alert(e)},success:function(){$("#datasend").val("")}}):bootbox.alert("Insert a message to send on the DataChannel to your peer")}function getQueryStringValue(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function addSimulcastButtons(e){$("#curres").parent().append('<div id="simulcast" class="btn-group-vertical btn-group-vertical-xs pull-right">\t<div class"row">\t\t<div class="btn-group btn-group-xs" style="width: 100%">\t\t\t<button id="sl-2" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to higher quality" style="width: 33%">SL 2</button>\t\t\t<button id="sl-1" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to normal quality" style="width: 33%">SL 1</button>\t\t\t<button id="sl-0" type="button" class="btn btn-primary" data-toggle="tooltip" title="Switch to lower quality" style="width: 34%">SL 0</button>\t\t</div>\t</div>\t<div class"row">\t\t<div class="btn-group btn-group-xs hide" style="width: 100%">\t\t\t<button id="tl-2" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 2" style="width: 34%">TL 2</button>\t\t\t<button id="tl-1" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 1" style="width: 33%">TL 1</button>\t\t\t<button id="tl-0" type="button" class="btn btn-primary" data-toggle="tooltip" title="Cap to temporal layer 0" style="width: 33%">TL 0</button>\t\t</div>\t</div></div>'),$("#sl-0").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (lower quality)",null,{timeOut:2e3}),$("#sl-2").hasClass("btn-success")||$("#sl-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl-1").hasClass("btn-success")||$("#sl-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl-0").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),videocall.send({message:{request:"set",substream:0}})}),$("#sl-1").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (normal quality)",null,{timeOut:2e3}),$("#sl-2").hasClass("btn-success")||$("#sl-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl-1").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#sl-0").hasClass("btn-success")||$("#sl-0").removeClass("btn-primary btn-info").addClass("btn-primary"),videocall.send({message:{request:"set",substream:1}})}),$("#sl-2").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Switching simulcast substream, wait for it... (higher quality)",null,{timeOut:2e3}),$("#sl-2").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#sl-1").hasClass("btn-success")||$("#sl-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#sl-0").hasClass("btn-success")||$("#sl-0").removeClass("btn-primary btn-info").addClass("btn-primary"),videocall.send({message:{request:"set",substream:2}})}),e&&($("#tl-0").parent().removeClass("hide"),$("#tl-0").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (lowest FPS)",null,{timeOut:2e3}),$("#tl-2").hasClass("btn-success")||$("#tl-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl-1").hasClass("btn-success")||$("#tl-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl-0").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),videocall.send({message:{request:"set",temporal:0}})}),$("#tl-1").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (medium FPS)",null,{timeOut:2e3}),$("#tl-2").hasClass("btn-success")||$("#tl-2").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl-1").removeClass("btn-primary btn-info").addClass("btn-info"),$("#tl-0").hasClass("btn-success")||$("#tl-0").removeClass("btn-primary btn-info").addClass("btn-primary"),videocall.send({message:{request:"set",temporal:1}})}),$("#tl-2").removeClass("btn-primary btn-success").addClass("btn-primary").unbind("click").click(function(){toastr.info("Capping simulcast temporal layer, wait for it... (highest FPS)",null,{timeOut:2e3}),$("#tl-2").removeClass("btn-primary btn-info btn-success").addClass("btn-info"),$("#tl-1").hasClass("btn-success")||$("#tl-1").removeClass("btn-primary btn-info").addClass("btn-primary"),$("#tl-0").hasClass("btn-success")||$("#tl-0").removeClass("btn-primary btn-info").addClass("btn-primary"),videocall.send({message:{request:"set",temporal:2}})}))}function updateSimulcastButtons(e,t){0===e?(toastr.success("Switched simulcast substream! (lower quality)",null,{timeOut:2e3}),$("#sl-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl-0").removeClass("btn-primary btn-info btn-success").addClass("btn-success")):1===e?(toastr.success("Switched simulcast substream! (normal quality)",null,{timeOut:2e3}),$("#sl-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl-1").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#sl-0").removeClass("btn-primary btn-success").addClass("btn-primary")):2===e&&(toastr.success("Switched simulcast substream! (higher quality)",null,{timeOut:2e3}),$("#sl-2").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#sl-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#sl-0").removeClass("btn-primary btn-success").addClass("btn-primary")),0===t?(toastr.success("Capped simulcast temporal layer! (lowest FPS)",null,{timeOut:2e3}),$("#tl-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl-0").removeClass("btn-primary btn-info btn-success").addClass("btn-success")):1===t?(toastr.success("Capped simulcast temporal layer! (medium FPS)",null,{timeOut:2e3}),$("#tl-2").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl-1").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#tl-0").removeClass("btn-primary btn-success").addClass("btn-primary")):2===t&&(toastr.success("Capped simulcast temporal layer! (highest FPS)",null,{timeOut:2e3}),$("#tl-2").removeClass("btn-primary btn-info btn-success").addClass("btn-success"),$("#tl-1").removeClass("btn-primary btn-success").addClass("btn-primary"),$("#tl-0").removeClass("btn-primary btn-success").addClass("btn-primary"))}$(document).ready(function(){Janus.init({debug:!0,callback:function(){$("#start").one("click",function(){$(this).attr("disabled",!0).unbind("click"),Janus.isWebrtcSupported()?janus=new Janus({server:server,success:function(){janus.attach({plugin:"janus.plugin.videocall",opaqueId:opaqueId,success:function(e){$("#details").remove(),videocall=e,Janus.log("Plugin attached! ("+videocall.getPlugin()+", id="+videocall.getId()+")"),$("#videocall").removeClass("hide").show(),$("#login").removeClass("hide").show(),$("#registernow").removeClass("hide").show(),$("#register").click(registerUsername),$("#username").focus(),$("#start").removeAttr("disabled").html("Stop").click(function(){$(this).attr("disabled",!0),janus.destroy()})},error:function(e){Janus.error("  -- Error attaching plugin...",e),bootbox.alert("  -- Error attaching plugin... "+e)},consentDialog:function(e){Janus.debug("Consent dialog should be "+(e?"on":"off")+" now"),e?$.blockUI({message:'<div><img src="up_arrow.png"/></div>',css:{border:"none",padding:"15px",backgroundColor:"transparent",color:"#aaa",top:"10px",left:navigator.mozGetUserMedia?"-100px":"300px"}}):$.unblockUI()},mediaState:function(e,t){Janus.log("Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){Janus.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),$("#videoleft").parent().unblock()},onmessage:function(e,t){Janus.debug(" ::: Got a message :::"),Janus.debug(e);var s=e.result;if(null!=s){if(void 0!==s.list&&null!==s.list){var a=s.list;for(var r in Janus.debug("Got a list of registered peers:"),Janus.debug(a),a)Janus.debug("  >> ["+a[r]+"]")}else if(void 0!==s.event&&null!==s.event){var l=s.event;if("registered"===l)myusername=s.username,Janus.log("Successfully registered as "+myusername+"!"),$("#youok").removeClass("hide").show().html("Registered as '"+myusername+"'"),videocall.send({message:{request:"list"}}),$("#phone").removeClass("hide").show(),$("#call").unbind("click").click(doCall),$("#peer").focus();else if("calling"===l)Janus.log("Waiting for the peer to answer..."),bootbox.alert("Waiting for the peer to answer...");else if("incomingcall"===l)Janus.log("Incoming call from "+s.username+"!"),yourusername=s.username,bootbox.hideAll(),incoming=bootbox.dialog({message:"Incoming call from "+yourusername+"!",title:"Incoming call",closeButton:!1,buttons:{success:{label:"Answer",className:"btn-success",callback:function(){incoming=null,$("#peer").val(s.username).attr("disabled",!0),videocall.createAnswer({jsep:t,media:{data:!0},simulcast:doSimulcast,success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);videocall.send({message:{request:"accept"},jsep:e}),$("#peer").attr("disabled",!0),$("#call").removeAttr("disabled").html("Hangup").removeClass("btn-success").addClass("btn-danger").unbind("click").click(doHangup)},error:function(e){Janus.error("WebRTC error:",e),bootbox.alert("WebRTC error... "+JSON.stringify(e))}})}},danger:{label:"Decline",className:"btn-danger",callback:function(){doHangup()}}}});else if("accepted"===l){bootbox.hideAll();var n=s.username;null==n?Janus.log("Call started!"):(Janus.log(n+" accepted the call!"),yourusername=n),t&&videocall.handleRemoteJsep({jsep:t}),$("#call").removeAttr("disabled").html("Hangup").removeClass("btn-success").addClass("btn-danger").unbind("click").click(doHangup)}else if("update"===l)t&&("answer"===t.type?videocall.handleRemoteJsep({jsep:t}):videocall.createAnswer({jsep:t,media:{data:!0},success:function(e){Janus.debug("Got SDP!"),Janus.debug(e);videocall.send({message:{request:"set"},jsep:e})},error:function(e){Janus.error("WebRTC error:",e),bootbox.alert("WebRTC error... "+JSON.stringify(e))}}));else if("hangup"===l)Janus.log("Call hung up by "+s.username+" ("+s.reason+")!"),bootbox.hideAll(),videocall.hangup(),null!=spinner&&spinner.stop(),$("#waitingvideo").remove(),$("#videos").hide(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide();else if("simulcast"===l){var i=s.substream,o=s.temporal;null==i&&null==o||(simulcastStarted||(simulcastStarted=!0,addSimulcastButtons("vp8"===s.videocodec||"h264"===s.videocodec)),updateSimulcastButtons(i,o))}}}else{var d=e.error;bootbox.alert(d),d.indexOf("already taken")>0&&($("#username").removeAttr("disabled").val(""),$("#register").removeAttr("disabled").unbind("click").click(registerUsername)),videocall.hangup(),null!=spinner&&spinner.stop(),$("#waitingvideo").remove(),$("#videos").hide(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide(),null!==bitrateTimer&&null!==bitrateTimer&&clearInterval(bitrateTimer),bitrateTimer=null}},onlocalstream:function(e){if(Janus.debug(" ::: Got a local stream :::"),Janus.debug(e),$("#videos").removeClass("hide").show(),0===$("#myvideo").length&&$("#videoleft").append('<video class="rounded centered" id="myvideo" width=320 height=240 autoplay playsinline muted="muted"/>'),Janus.attachMediaStream($("#myvideo").get(0),e),$("#myvideo").get(0).muted="muted","completed"!==videocall.webrtcStuff.pc.iceConnectionState&&"connected"!==videocall.webrtcStuff.pc.iceConnectionState)if($("#videoleft").parent().block({message:"<b>Publishing...</b>",css:{border:"none",backgroundColor:"transparent",color:"white"}}),$("#videoright").append('<video class="rounded centered" id="waitingvideo" width=320 height=240 />'),null==spinner){var t=document.getElementById("videoright");spinner=new Spinner({top:100}).spin(t)}else spinner.spin();var s=e.getVideoTracks();null==s||0===s.length?($("#myvideo").hide(),0===$("#videoleft .no-video-container").length&&$("#videoleft").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No webcam available</span></div>')):($("#videoleft .no-video-container").remove(),$("#myvideo").removeClass("hide").show())},onremotestream:function(e){Janus.debug(" ::: Got a remote stream :::"),Janus.debug(e);var t=!1;0===$("#remotevideo").length&&(t=!0,$("#videoright").append('<video class="rounded centered hide" id="remotevideo" width=320 height=240 autoplay playsinline/>'),$("#remotevideo").bind("playing",function(){$("#waitingvideo").remove(),this.videoWidth&&$("#remotevideo").removeClass("hide").show(),null!=spinner&&spinner.stop(),spinner=null;var e=this.videoWidth,t=this.videoHeight;$("#curres").removeClass("hide").text(e+"x"+t).show()}),$("#callee").removeClass("hide").html(yourusername).show()),Janus.attachMediaStream($("#remotevideo").get(0),e);var s=e.getVideoTracks();null==s||0===s.length?($("#remotevideo").hide(),0===$("#videoright .no-video-container").length&&$("#videoright").append('<div class="no-video-container"><i class="fa fa-video-camera fa-5 no-video-icon"></i><span class="no-video-text">No remote video available</span></div>')):($("#videoright .no-video-container").remove(),$("#remotevideo").removeClass("hide").show()),t&&(audioenabled=!0,videoenabled=!0,$("#toggleaudio").html("Disable audio").removeClass("btn-success").addClass("btn-danger").unbind("click").removeAttr("disabled").click(function(){(audioenabled=!audioenabled)?$("#toggleaudio").html("Disable audio").removeClass("btn-success").addClass("btn-danger"):$("#toggleaudio").html("Enable audio").removeClass("btn-danger").addClass("btn-success"),videocall.send({message:{request:"set",audio:audioenabled}})}),$("#togglevideo").html("Disable video").removeClass("btn-success").addClass("btn-danger").unbind("click").removeAttr("disabled").click(function(){(videoenabled=!videoenabled)?$("#togglevideo").html("Disable video").removeClass("btn-success").addClass("btn-danger"):$("#togglevideo").html("Enable video").removeClass("btn-danger").addClass("btn-success"),videocall.send({message:{request:"set",video:videoenabled}})}),$("#toggleaudio").parent().removeClass("hide").show(),$("#bitrateset").html("Bandwidth"),$("#bitrate a").unbind("click").removeAttr("disabled").click(function(){var e=$(this).attr("id"),t=1e3*parseInt(e);return 0===t?Janus.log("Not limiting bandwidth via REMB"):Janus.log("Capping bandwidth to "+t+" via REMB"),$("#bitrateset").html($(this).html()).parent().removeClass("open"),videocall.send({message:{request:"set",bitrate:t}}),!1}),"chrome"!==Janus.webRTCAdapter.browserDetails.browser&&"firefox"!==Janus.webRTCAdapter.browserDetails.browser&&"safari"!==Janus.webRTCAdapter.browserDetails.browser||($("#curbitrate").removeClass("hide").show(),bitrateTimer=setInterval(function(){var e=videocall.getBitrate();$("#curbitrate").text(e);var t=$("#remotevideo").get(0).videoWidth,s=$("#remotevideo").get(0).videoHeight;t>0&&s>0&&$("#curres").removeClass("hide").text(t+"x"+s).show()},1e3)))},ondataopen:function(e){Janus.log("The DataChannel is available!"),$("#videos").removeClass("hide").show(),$("#datasend").removeAttr("disabled")},ondata:function(e){Janus.debug("We got data from the DataChannel! "+e),$("#datarecv").val(e)},oncleanup:function(){Janus.log(" ::: Got a cleanup notification :::"),$("#myvideo").remove(),$("#remotevideo").remove(),$("#videoleft").parent().unblock(),$(".no-video-container").remove(),$("#callee").empty().hide(),yourusername=null,$("#curbitrate").hide(),$("#curres").hide(),$("#videos").hide(),$("#toggleaudio").attr("disabled",!0),$("#togglevideo").attr("disabled",!0),$("#bitrate").attr("disabled",!0),$("#curbitrate").hide(),$("#curres").hide(),null!==bitrateTimer&&null!==bitrateTimer&&clearInterval(bitrateTimer),bitrateTimer=null,$("#waitingvideo").remove(),$("#videos").hide(),simulcastStarted=!1,$("#simulcast").remove(),$("#peer").removeAttr("disabled").val(""),$("#call").removeAttr("disabled").html("Call").removeClass("btn-danger").addClass("btn-success").unbind("click").click(doCall)}})},error:function(e){Janus.error(e),bootbox.alert(e,function(){window.location.reload()})},destroyed:function(){window.location.reload()}}):bootbox.alert("No WebRTC support... ")})}})});